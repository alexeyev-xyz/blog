---
layout: post
title: "Аналог ОРФУС в HGHMAG.RU"
date: 2014-08-23 00:00:00 +0300
tags: [Imported]
---

Опечатки и пунктуационные ошибки - беда для сайтов с уникальным контентом, никто от них не застрахован. Чтобы улучшить качество контента, российский программист Дмитрий Котеров<font color="#000000" face="arial, sans-serif" size="3"></font>разработал ОРФографическое Улучшение Сайтов (сокр. ОРФУС) - небольшой встраиваемый скрипт, который позволяет всем посетителям жаловаться на опечатки. Суть его проста, пользователь выделяет место с ошибкой и по нажатию ctrl + enter скрипт отправляет сообщение об ошибке на e-mail администраторам сайта.
Сайт программного продукта [[http://orphus.ru/](http://orphus.ru/)] говорит, что за время существования скрипт установили более чем на 10000 сайтах.
Однако в 2014 году возникает логичный вопрос - **удобно ли мониторить почтовый ящик**?  С одной стороны, можно настроить push уведомления на мобильных устройствах, но если ошибки необходимо видеть сразу нескольким корректорам, то каждому придется настраивать эти самые уведомления. 

Идею подсказал Илья Чекальский [[https://vk.com/chekalskiy](https://vk.com/chekalskiy)] из TJOURNAL - он предложил слать сообщения в редакторский чат VK, убивая нескольких зайцев сразу - все редакторы и корректоры сидят Вконтакте и мы по сути получаем push-уведомления "из коробки" как на десктопной версии сайта, так и в мобильных приложениях. Очень удобно!

_Технология проста до безобразия._

1\. Пользователь выделяет место с ошибкой - клиентский скрипт отправляет POST-запрос на обработчик на нашем сервере
2\. Обработчик через VK API отправляет сообщение в беседу 

Задача. Написать скрипт на клиенте и обработчик за короткий срок с минимальным интерфейсом и внедрить в HGHMAG. 

Вот как это выглядит:
![Снимок экрана 2014-08-23 в 15.43.58](http://ic.pics.livejournal.com/vlaimspb/71326704/2297/2297_900.png "Снимок экрана 2014-08-23 в 15.43.58")

**Проблема 1\. "Защита от дурака"**

Ситуация. Кто-то решил пошутить или просто посмотреть что будет если отправить сообщение об ошибке 1000 раз подряд. В итоге редакторский чат заполнен однотипными сообщениями и VK включает flood control. 

_Ограничение 1.1_ Каждый пользователь может отправлять запрос только раз в минуту

Так как на сайте 99.999% пользователей не авторизованы, то в таком случае единственным идентификатором пользователя является его IP адрес. Нам нужно записывать куда-либо информацию о каждом пользователе, в т.ч. время его последнего запроса. Для этой цели подойдет либо memcache, либо отдельная таблица в БД. Лично я выбрал второй вариант. В качестве primary key используем ip, пишем время последнего запроса и флаг бана (об этом позже) 

![Снимок экрана 2014-08-23 в 15.59.17](http://ic.pics.livejournal.com/vlaimspb/71326704/2555/2555_900.png "Снимок экрана 2014-08-23 в 15.59.17")

_Ограничение 1.2_ Бан самым упертым

Если кто-то продолжает спамить отправляя ошибки в чат, то просто баним его IP, т.е. в таблице меням флаг бана с 0 на 1\. Чтобы не запариваться с интерфейсом админки для раздачи банов и амнистий было решено просто сделать отдельный action, который будет банить ip и при передаче особого GET-параметра разбанивать. 

![Снимок экрана 2014-08-23 в 16.26.55](http://ic.pics.livejournal.com/vlaimspb/71326704/2615/2615_900.png "Снимок экрана 2014-08-23 в 16.26.55")

**Проблема 2\. CAPTHA VK API**

Иногда VK надо убеждать, что все под контролем и сообщения шлет не спам-бот, поэтому без иногда всплывающей капчи не обойтись.

![Снимок экрана 2014-08-23 в 16.36.38](http://ic.pics.livejournal.com/vlaimspb/71326704/2948/2948_900.png "Снимок экрана 2014-08-23 в 16.36.38")

**Что под капотом**

Отправляется единственный запрос к API messages.send
Существует куча оберток под любой серверный язык для VK API, тут добавить нечего
Механизм авториции стандартный - получаем access token и token secret и работаем с ними
Может быть дойдут руки причесать код и выложить в репозиторий во имя open source :) 

_<u>Примечание</u>_ Доступ к личным сообщениям доступен только standalone-приложениям VK!

**Как это видит пользователь**

Не стоит изобретать заново велосипед - легковесный плагин JQuery Noty хорошо справляется с задачей выводить информационные сообщения: 

![Снимок экрана 2014-08-23 в 16.46.42](http://ic.pics.livejournal.com/vlaimspb/71326704/3100/3100_900.png "Снимок экрана 2014-08-23 в 16.46.42")

![Снимок экрана 2014-08-23 в 16.45.49](http://ic.pics.livejournal.com/vlaimspb/71326704/3363/3363_900.png "Снимок экрана 2014-08-23 в 16.45.49")

![Снимок экрана 2014-08-23 в 16.45.27](http://ic.pics.livejournal.com/vlaimspb/71326704/3782/3782_900.png "Снимок экрана 2014-08-23 в 16.45.27")

Вот такая вот простая штука, которая облегчает жизнь корректорам и делает контент лучшe :)